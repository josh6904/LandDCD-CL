<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCD Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <div class="brand-text">
                <div class="brand-name">DCD</div>
                <div class="brand-subtitle">Possess The Land</div>
            </div>
        </div>

        <!-- Keyboard Shortcuts Hint -->
        <div style="margin-top: auto; padding:16px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.7rem; color: #9CA3AF;">
            <strong>‚å®Ô∏è Shortcuts:</strong><br>
            N = New Pledge<br>
            C = Record Cash
        </div>

        <nav class="nav-group">
            <div class="nav-item active" onclick="app.router('dashboard')">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Dashboard</span>
            </div>
            <div class="nav-item" onclick="app.router('pledges')">
                <span class="nav-icon">ü§ù</span>
                <span class="nav-label">Pledges</span>
            </div>
            <div class="nav-item" onclick="app.router('ledger')">
                <span class="nav-icon">üí∞</span>
                <span class="nav-label">Ledger</span>
            </div>
            <div class="nav-item" onclick="app.router('expenses')">
                <span class="nav-icon">üìâ</span>
                <span class="nav-label">Expenses</span>
            </div>
            <div class="nav-item" onclick="app.router('tribes')">
                <span class="nav-icon">üèÜ</span>
                <span class="nav-label">Depts</span>
            </div>
            <div class="nav-item" onclick="app.router('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Settings</span>
            </div>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-container">
        
        <!-- DASHBOARD -->
        <section id="view-dashboard">
            <div class="page-header">
                <div>
                    <h1>Overview</h1>
                    <p class="page-subtitle">Real-time tracking for <strong>DCD Possess The Land</strong></p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="app.generateSnapshot()">üì∏ Daily Snapshot</button>
                    <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </div>

            <!-- KPI CARDS -->
            <div class="kpi-grid">
                <div class="kpi-card kpi-success">
                    <div class="kpi-label">Gross Cash</div>
                    <div class="kpi-value" id="dash-cash">KES 0</div>
                    <div class="kpi-icon">üí∞</div>
                </div>
                <div class="kpi-card kpi-danger">
                    <div class="kpi-label">Expenses</div>
                    <div class="kpi-value" id="dash-expenses">KES 0</div>
                    <div class="kpi-icon">üìâ</div>
                </div>
                
                <!-- NET CASH WITH PROJECTION -->
                <div class="kpi-card kpi-info">
                    <div class="kpi-label">Net Cash</div>
                    <div class="kpi-value" id="dash-net">KES 0</div>
                    <!-- THE "POSSIBILITY" BAR -->
                    <div class="projection-container">
                        <div class="projection-bar" id="proj-bar" style="width: 0%;"></div>
                    </div>
                    <div class="kpi-icon">üíµ</div>
                </div>

                <div class="kpi-card kpi-primary">
                    <div class="kpi-label">Total Pledged</div>
                    <div class="kpi-value" id="dash-pledges">KES 0</div>
                    <div class="kpi-icon">üéØ</div>
                </div>
                
                <!-- Efficiency Donut -->
                <div class="kpi-card kpi-accent" id="card-efficiency" style="display: flex; align-items: center; justify-content: center; padding: 0; overflow: hidden;">
                    <div style="width: 100%; height: 100%; position: relative;">
                        <svg id="chart-efficiency" class="chart" viewBox="0 0 36 36"></svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div id="dash-rate" style="font-size: 1.2rem; font-weight: 800;">0%</div>
                            <div style="font-size: 0.65rem; color: #9CA3AF; text-transform: uppercase; font-weight: 700;">Efficiency</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-grid">
                <!-- Bar Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Department Performance</div>
                        <button class="btn btn-sm btn-secondary" onclick="app.router('tribes')">View All</button>
                    </div>
                    <div id="chart-departments" style="height: 250px; width: 100%;"></div>
                </div>

                <!-- Recent Activity -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Recent Activity</div>
                    </div>
                    <div id="recent-activity" style="display: flex; flex-direction: column; gap: 12px;">
                        <p class="text-muted" style="text-align: center; padding: 20px;">No recent activity.</p>
                    </div>
                </div>
            </div>
            
            <!-- Phase Progress -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Phases & Targets</div>
                    <button class="btn btn-sm btn-secondary" onclick="app.router('settings')">Edit</button>
                </div>
                <div id="phase-list"></div>
            </div>
        </section>

        <!-- PLEDGES VIEW -->
        <section id="view-pledges" class="hidden">
            <div class="page-header">
                <h1>Member Pledges</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="document.getElementById('csv-upload').click()">üìÇ Import CSV</button>
                    <input type="file" id="csv-upload" accept=".csv" style="display: none;" onchange="app.handleCSVUpload(this)">
                    <button class="btn btn-secondary" onclick="app.exportCSV('pledges')">üì• Export</button>
                    <button class="btn btn-primary" onclick="app.openModal('pledge')">+ New Pledge</button>
                </div>
            </div>
            <div class="search-wrapper">
                <input type="text" id="pledge-search" placeholder="üîç Search members..." onkeyup="app.renderPledges()">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Dept</th>
                            <th class="text-right">Pledged</th>
                            <th class="text-right">Paid</th>
                            <th class="text-right">Balance</th>
                            <th class="text-right">Status</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="pledges-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- EXPENSES VIEW -->
        <section id="view-expenses" class="hidden">
            <div class="page-header">
                <h1>Expenses Tracker</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="app.exportCSV('expenses')">üì• Export</button>
                    <button class="btn btn-danger" onclick="app.openModal('expense')">üìâ Record Expense</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th class="text-right">Amount</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- LEDGER VIEW -->
        <section id="view-ledger" class="hidden">
            <div class="page-header">
                <h1>Transaction Ledger</h1>
                <button class="btn btn-secondary" onclick="app.exportCSV('ledger')">üì• Export Audit</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Ref</th>
                            <th>Details</th>
                            <th>Type</th>
                            <th class="text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="ledger-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- DEPARTMENTS VIEW -->
        <section id="view-tribes" class="hidden">
            <div class="page-header">
                <h1>Department Performance</h1>
            </div>
            <div id="tribes-container" class="tribes-grid"></div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="view-settings" class="hidden">
            <div class="page-header">
                <h1>Admin Settings</h1>
            </div>
            <div class="settings-group">
                <h3>üíæ Backup & Restore</h3>
                <p>Save your data to a file or restore from a previous backup.</p>
                <div class="settings-actions">
                    <button class="btn btn-primary" onclick="app.downloadBackup()">üíæ Download Backup</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('restore-input').click()">üìÇ Restore Backup</button>
                    <input type="file" id="restore-input" accept=".json" style="display: none;" onchange="app.restoreBackup(this)">
                </div>
            </div>
            
            <div class="settings-group">
                <h3>üìÖ Manage Collection Phases</h3>
                <p>Define collection targets for specific dates.</p>
                <form onsubmit="app.addPhaseFromForm(event)" class="settings-form">
                    <div class="form-row">
                        <input type="text" id="phase-name" required placeholder="Phase Name (e.g. Easter Offering)">
                        <input type="date" id="phase-date" required>
                    </div>
                    
                    <h4>Department Targets</h4>
                    <div id="dept-targets-container" class="form-grid-targets"></div>
                    
                    <div class="total-preview-row">
                        Total Project Target: <span id="total-target-preview">KES 0</span>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">Create Phase</button>
                </form>

                <h4>Existing Phases</h4>
                <div id="settings-phase-list" class="phase-list-settings"></div>
            </div>

            <div class="settings-group danger-zone">
                <h3>‚ö†Ô∏è Danger Zone</h3>
                <p>Permanently delete all application data.</p>
                <button class="btn btn-danger" onclick="app.hardReset()">Reset All Data</button>
            </div>
        </section>

    </main>

    <!-- MODALS -->
    
    <!-- PLEDGE MODAL -->
    <div class="modal-overlay" id="modal-pledge">
        <div class="modal">
            <div class="modal-header">
                <h3>New Pledge</h3>
                <button class="close-modal" onclick="app.closeModal('pledge')">&times;</button>
            </div>
            <form onsubmit="app.submitPledge(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Member Name</label>
                        <input type="text" name="name" required placeholder="e.g. John Doe">
                    </div>
                    
                    <div class="form-group">
                        <label>Department</label>
                        <select name="department" id="modal-dept-select" required></select>
                    </div>
                    
                    <div class="form-group">
                        <label>Pledge Amount (KES)</label>
                        <input type="number" name="amount" required min="1" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('pledge')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Pledge</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EXPENSE MODAL -->
    <div class="modal-overlay" id="modal-expense">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Expense</h3>
                <button class="close-modal" onclick="app.closeModal('expense')">&times;</button>
            </div>
            <form onsubmit="app.submitExpense(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expense-category" required>
                            <option value="General">General</option>
                            <option value="Logistics">Logistics (Transport/Fuel)</option>
                            <option value="Venue">Venue/Hall Booking</option>
                            <option value="Marketing">Marketing/Print</option>
                            <option value="Refreshments">Refreshments/Catering</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expense-desc" required placeholder="e.g. Transport to venue">
                    </div>
                    
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="expense-amount" required min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('expense')">Cancel</button>
                    <button type="submit" class="btn btn-danger">Record</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDIT PLEDGE MODAL -->
    <div class="modal-overlay" id="modal-edit-pledge">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Pledge</h3>
                <button class="close-modal" onclick="app.closeModal('edit-pledge')">&times;</button>
            </div>
            <form onsubmit="app.updatePledgeSubmit(event)">
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" name="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Department</label>
                        <select name="department" id="edit-dept-select" required></select>
                    </div>
                    
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" name="amount" required min="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('edit-pledge')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MANUAL CASH MODAL -->
    <div class="modal-overlay" id="modal-manual-cash">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Cash</h3>
                <button class="close-modal" onclick="app.closeModal('manual-cash')">&times;</button>
            </div>
            <form onsubmit="app.submitManualCash(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Payer Name</label>
                        <input type="text" id="cash-name" list="member-list" required placeholder="Name">
                        <datalist id="member-list"></datalist>
                    </div>

                    <div class="form-group">
                        <label>Department</label>
                        <select id="cash-dept" required></select>
                    </div>

                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="cash-amount" required min="1">
                    </div>
                    
                    <div class="form-group">
                        <label>Reference/Note</label>
                        <input type="text" id="cash-ref" placeholder="e.g. Offering Envelope #1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('manual-cash')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SMS PARSER MODAL -->
    <div class="modal-overlay" id="modal-sms-parse">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>‚ö° M-Pesa SMS Parser</h3>
                <button class="close-modal" onclick="app.closeModal('sms-parse')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 12px; font-size: 0.9rem; color: var(--text-muted);">Paste SMS confirmation messages below. Click "Extract" to parse.</p>
                <textarea id="sms-input" class="sms-textarea" placeholder="Paste M-Pesa SMS messages here..."></textarea>
                
                <div id="staged-area" class="staged-section hidden">
                    <div class="staged-header">
                        <strong>Found Transactions (<span id="staged-count">0</span>)</strong>
                        <small class="text-muted">Review before committing</small>
                    </div>
                    <div id="staged-list" class="staged-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="app.closeModal('sms-parse')">Close</button>
                <button type="button" class="btn btn-primary" id="btn-parse-trigger" onclick="app.processSMS()">‚ö° Extract Data</button>
                <button type="button" class="btn btn-primary hidden" id="btn-commit-trigger" onclick="app.commitStaged()">Commit All</button>
            </div>
        </div>
    </div>

    <!-- SNAPSHOT MODAL (NEW) -->
    <div class="modal-overlay" id="modal-snapshot">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>üì∏ Daily Snapshot Report</h3>
                <button class="close-modal" onclick="app.closeModal('snapshot')">&times;</button>
            </div>
            <div class="modal-body" style="background: #fff; border: 1px solid #ddd; padding: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="font-size: 2rem; color: var(--primary);">DCD POSSESS THE LAND</h2>
                    <h4 id="snapshot-date" style="color: var(--text-muted);">DATE</h4>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <strong>Today's Gross Cash</strong>
                        <div id="snap-cash" style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">KES 0</div>
                    </div>
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <strong>Today's Expenses</strong>
                        <div id="snap-expenses" style="font-size: 1.5rem; font-weight: 800; color: var(--danger);">KES 0</div>
                    </div>
                </div>

                <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                    <h4 style="margin-bottom: 10px;">Transaction Details</h4>
                    <div id="snapshot-details" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="window.print()">Print Report</button>
                <button type="button" class="btn btn-primary" onclick="app.closeModal('snapshot')">Close</button>
            </div>
        </div>
    </div>

    <!-- QUICK CASH FAB (NEW) -->
    <div class="fab" onclick="app.openModal('manual-cash')" title="Record Cash (Shortcut: 'C')">
        <span class="fab-icon">üíµ</span>
    </div>

    <div id="toast-container"></div>
    <script src="script.js"></script>
</body>
</html>